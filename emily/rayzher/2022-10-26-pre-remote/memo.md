# **_第二次開發(遠端)預計處理事項_**

## **使用者提供之 CSV**

- 新增欄位
  - apmp200 執行結果
    - apmp200 DA 轉拋成功的情況，產生單號
    - 失敗情況：依據單號，但系統中搜尋結果為空白
      - 此時應該寫入自製的錯誤訊息，並終止此次循環進入下一筆資料。
  - apmt540 執行結果
    - apmpt540 DA 所有流程成功，寫入 eazyflow 簽核成功訊息
    - apmpt540 DA 失敗
      - eazyflow 簽核失敗，寫入失敗訊息

## **某些彈窗的確認按鈕需改 ENTER 鍵執行**

- 有些彈窗的確認按鈕會多外框
  - 會造成掃描錯誤
  - 如果是此狀態下需要點及確認的步驟
    - 應該改為直接 api.keyboard.enter() 執行，而非使用掃描點擊

## **DA CROPs 優化**

- 第一次開發時有很多 CROP 是重複截圖。
  - 相同的圖片應該重複利用，以縮短第一次進入 DA 時的 CROP 載入時間。
- 即使切割成兩個 DA，apmt540 DA 也可以直接利用到 apmp200 DA 下載的 CROP
  - 所以考慮在切割之前先做這部分優化，直到這部分完成之後再進行切割。
    - 邏輯較簡單
    - CROP 這樣就可以都在進入第一個 DA (apmp200) 時都下載好。
    - 跨 DA 進行 CROP 重複利用。

## **將 apmp200 與 apmt540 切割成兩個 DA**

- 理由？
  - 不需要重複開啟關閉介面。
  - 例外情況發生在 apmt540 時，apmp200 已經把這筆單轉拋完成的情況發生時
    - 如果使用 apmp200 與 apmt540 合併寫在同一個 DA 的處理方法的話：
      - 下一次要執行這筆單，會發生已經轉拋過導致 DA 前半失敗無法進入後半 apmt540 的狀況。
    - 如果 apmp200 與 apmt540 分開在不同 DA 去做處理的話：
      - 做兩個循環，第一個 for apmp200、第二個 for ampt540
        - 兩個循環依循的 CSV 有事先被 codes 篩選過
          - apmp200 循環 CSV = 欄位【apmp200 執行結果】為空
          - apmt540 循環 CSV = 欄位【apmp200 執行結果】不為空 && 【apmt540 執行結果】為空

## **將跑循環使用的 CSV 與使用者提供的 CSV 隔離**

1. 使用者提供的 CSV -> apmp200 循環用 CSV
2. apmp200 循環中不斷將結果寫入【使用者提供 CSV】
3. apmp200 循環結束
4. 使用者提供的 CSV -> apmt540 循環用 CSV
5. apmt540 循環中不斷將結果寫入【使用者提供 CSV】
6. apmt540 循環結束

- 過程中的寫入動作都是寫入【使用者提供 CSV】，不會動到真正循環所使用的 CSV。
- 步驟 4. 的【使用者提供的 CSV】已經是被步驟 2.修改過的結果。

## **將結果寫入原本 CSV 檔案**

- 分成 apmp200 與 apmt540 兩部分。
- 每次得到結果就寫入，而不是等迴圈完全結束才寫入。
  - memory 中的 JSON object 在技能尚未結束前都會持續存在且會經歷多次更改，只是更改時要使用 api.write 覆蓋原本的 CSV 而已。

## **關閉介面**

- 使用 ESC 熱鍵關閉
  - 避免掃描錯誤
  - 但是第一個 UI 也能夠被 ESC 關閉，導致直接離開 ERP 登入狀態。
    - 所以或許，可能會有不小心直接登出整個 ERP 的情況？
      - 加入判斷？
        - 第一個 UI 中是否有明顯圖示，若有，可以用 waitFor 依據此圖示判斷是否已經回到第一個 UI。
- 如果是把 apmp200 與 apmpt540 用成兩個循環的話，關閉界面的操作就剩下兩次。

## **將部分資料從原本 CSV 中轉移到另一個 CSV 儲存**

- 依照這個邏輯，另一個 CSV 有越長越大直到無限大的風險。

  - Emily 寫入 CSV 檔案只能先讀原本 CSV 中的所有資料在透過 JS 語法增加新的部分以後寫入，這樣檔案太大可能會崩潰。
  - 所以應該依照某些邏輯去切割檔案？
    - 日期 (用這個最簡單)
    - 筆數
    - CSV 檔案大小

- 應該在技能最後階段，所有循環之外，獨立進行這部分工作
  - 因為循環之中會參雜寫入 CSV 的操作，所以應該區分清楚避免混亂
  - 把使用者提供 CSV 中，欄位【apmp200 執行結果】有失敗之值，或者欄位【apmt540 執行結果】中有值(不分成功、失敗)，轉移到另一個 CSV 中儲存。

## **Validation**

- 使用者輸入部分一定會出錯的原則
  - 可以檢查到的輸入錯誤
    - 可以直接在跑 CSV 循環中，讀取到的某筆資料先對每個欄位使用者填入的值做檢查
  - 檢查不到的錯誤
    - 例如：
      - 單號看起來正常，但已經轉拋過
      - 金額看起來正常，但是會在 ez 簽核結果 show 出錯誤訊息
      - 日期看起來正常，但會直接在單身輸入時卡住
    - 只能在執行到填入時，等到 ERP 系統產生錯誤訊息才能知道使用者提供的資料有錯誤

## **安裝時需提供的資料**

- 為了可以讓使用者可以直接指定網路芳鄰中的路徑
  - 使用者提供之 CSV 路徑
