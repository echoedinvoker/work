# **_取得採購單號_**

## **找到應該處理的【專案號碼/請購單號】**

### _apmp200 Export Excel_

![Alt export excel](pic/bandicam%202022-10-06%2008-49-43-833.jpg)

- Ctrl+T: **apmp200**

- Filter by
  - 請購單性質 = SUB
  - 確認否 = Y:已確認
  - 狀況碼 = 1:已核准
- Map return only **專案號碼**

### _Loop 上面專案號碼到 CSV 檔案中提取資料_

![Alt CSV](pic/bandicam%202022-10-06%2009-12-38-869.jpg)

- 使用前一步驟得到的 **專案號碼**，到 CSV 檔案中確認：

  - 是否有該 **專案號碼** 的資料
  - 該筆資料是否具備 **採購員編號** / **未稅金額** / **日期** 三者的資料
  - 該筆資料的 **採購單號** 欄位是否空白

- 將符合上述條件的資料提取出來轉成 JSON 如下：

![Alt project JSON](pic/bandicam%202022-10-06%2009-27-54-235.jpg)

## **Loop 專案，取得採購單號**

### _選擇專案_

- Loop 上面 JSON 物件，在 **apmp200** 進行 **DA** 操作如下：
  1.  使用 **專案編號** 篩選出單筆資料
      - 考量一筆專案編號會帶出多筆採購單號，所以**不**同時拋轉多筆專案。
  2.  勾選資料最左邊選取
  3.  點擊右邊確認按鈕

![Alt](pic/bandicam%202022-10-06%2009-43-13-145.jpg)

### _填寫基本資料，取得採購單號_

![Alt fill basic info](pic/bandicam%202022-10-06%2009-52-10-277.jpg)
![Alt purchase numbers](pic/bandicam%202022-10-06%2009-55-22-707.jpg)

- 上面得到的每筆 **採購單號** 與當前 iteration 的 JSON Object 組成 Array of Objects 如下：

![Alt purchase JSON](pic/bandicam%202022-10-06%2010-04-52-502.jpg)

# **_處理採購單號_**

## **資料源**

- Loop 上面的 Array of Objects 進行採購單的操作。
  - 因為外層已經在 Loop 專案號碼，加上這層採購單號的 Loop 會形成 nested loop。
    - 採購單號這部分的處理，考慮撰寫在子技能中，在主技能中使用 api.run 的方法 loop。

## **新增採購單號**

![Alt add purchase number](pic/bandicam%202022-10-06%2010-30-44-546.jpg)

## **單身(熱鍵 B 進入編輯)**

![Alt enter single body](pic/bandicam%202022-10-06%2010-18-19-418.jpg)

### _未稅金額_

![Alt amount](pic/bandicam%202022-10-06%2010-37-01-371.jpg)

- demo 影片中填入的欄位是 **單價**，但 Object property 是 **金額**，需再作釐清，是否 CSV 檔案中提供的是 未稅**單價**。

### _日期_

![alt date](pic/bandicam%202022-10-06%2010-45-15-801.jpg)

- **日期** 會在 **專案編號/請購單號 CSV** 提供
- 有三個並排的日期欄位，填入第一個之後，案兩次 TAB 讓後面兩個欄位自動代入第一格的日期。

### _確定:成功/失敗_

> 按下確定後有成功與失敗兩種結果。

**成功**

![Alt singleBody success](pic/bandicam%202022-10-06%2010-49-17-874.jpg)

- 確認若成功即離開了單身編輯模式，繼續下一步驟 **相關文件上傳**。

**失敗**

![Alt singleBody failed](pic/bandicam%202022-10-06%2010-54-11-674.jpg)

- 若失敗則此 iteration 結束，進入下一筆採購單號或專案號碼 iteration。

## **相關文件上傳**

![Alt click module](pic/bandicam%202022-10-06%2010-58-43-683.jpg)
![Alt fill path](pic/bandicam%202022-10-06%2011-15-18-016.jpg)
![Alt describ confirm](pic/bandicam%202022-10-06%2011-11-59-903.jpg)
![Alt Warning](pic/bandicam%202022-10-06%2011-21-05-041.jpg)

- 需上傳的檔案會以專案名稱去進行命名，且皆會放在固定的資料夾中
  - 故可由固定資料夾的路徑與專案名稱組成正確的上傳所需路徑。
- 說明欄位需填入 **請購單號**
- 彈出成功視窗，按確認關閉視窗
- 點擊離開

## **重新產生發包價**

![Alt click module](pic/bandicam%202022-10-06%2011-23-23-574.jpg)
![Alt renew amount](pic/bandicam%202022-10-06%2011-25-01-281.jpg)

- 意義在於讓系統去抓我們剛剛 key 的未稅單價的資料，否則下一步驟 **EasyFlow 送簽** 會出現金額不符合的錯誤。

## **EasyFlow 送簽**

### _點擊模組按鈕_

![Alt easyflow module](pic/bandicam%202022-10-06%2011-27-41-390.jpg)

### _失敗情況_

![Alt date failed](pic/bandicam%202022-10-06%2011-29-48-169.jpg)

- 前面日期有正常填入的話可以避免掉此錯誤。

![Alt XML failed](pic/bandicam%202022-10-06%2011-32-12-472.jpg)

- 正常上線時，也會出現送簽失敗情況，所以要辨認失敗與成功狀況，失敗時也要記錄錯誤訊息與採購單號，以便人員複查。

### _送簽成功情況_

- 沒 demo 成功情況，如何辨認成功尚無解答。

# **_CSV 檔案整理、備份_**

- 所有專案跑完之後進行檔案的整理

  1.  CSV 中成功的專案、失敗的專案分別寫入不同的 CSV 檔案
      - 放置在與原本 CSV 檔案不同的資料夾。
      - 檔名需附帶日期時間，已方便觀察每次工作進度。
  2.  將原本 CSV 檔案中處理過的專案刪除。
      - 會議中是提到說用人工刪除，應該可直接用機器流程取代。
      - 僅保留機器人需要使用的資料，避免資料量越來越多造成 Loop 越來越久的情況發生。

- 錯誤訊息是在訊息產生時直接寫入最初的 CSV 檔案中，應有一欄是專門填寫錯誤訊息，如此可以直接使用該欄位是否有值確認該專案是成功或失敗。
- 每次進入一個採購單號的 iteration 時，將此採購單號記錄到最初的 CSV 所對應的專案中，應有一欄是記錄已處理的採購單號。
  - 可用此欄有無值判斷專案是否處理過。
  - 一專案可能有多筆採購單號，所以此欄位會記錄多筆採購單號。
    - 採購單號之間需用**非逗號**的符號或空格隔開。
